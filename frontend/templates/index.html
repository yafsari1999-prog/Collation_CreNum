<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collation CreNum - Interface de collation automatique</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container-fluid">
        <header class="py-3 mb-4 border-bottom">
            <h1 class="text-center">Interface de Collation Automatique - Projet CreNum</h1>
            <p class="text-center text-muted">Comparaison de manuscrits en moyen français</p>
        </header>

        <!-- Étape 1: Sélection de l'œuvre -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Étape 1 : Sélection de l'œuvre</h5>
                    </div>
                    <div class="card-body">
                        <label class="form-label">Choisir une œuvre existante</label>
                        <div id="works-list" class="border rounded p-3" style="max-height: 250px; overflow-y: auto; min-height: 100px;">
                            <p class="text-muted text-center">Chargement des œuvres...</p>
                        </div>
                        <div class="mt-3">
                            <button type="button" class="btn btn-success w-100" data-bs-toggle="modal" data-bs-target="#addWorkModal">
                                Ajouter une nouvelle œuvre
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 2: Sélection des témoins -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Étape 2 : Sélection des témoins (3 requis)</h5>
                    </div>
                    <div class="card-body" id="witnesses-section">
                        <p class="text-muted">Veuillez d'abord sélectionner une œuvre</p>
                        
                        <div id="witness-selection" style="display: none;">
                            <label class="form-label">Sélectionnez 3 témoins maximum</label>
                            <div id="witnesses-list" class="border rounded p-3" style="max-height: 250px; overflow-y: auto; min-height: 100px;">
                                <p class="text-muted text-center">Aucun témoin disponible</p>
                            </div>
                            <div class="mt-3">
                                <button type="button" class="btn btn-success w-100" onclick="openAddWitnessModal()">
                                    Ajouter un nouveau témoin
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Étape 3: Sélection du chapitre -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Étape 3 : Sélection du chapitre</h5>
                    </div>
                    <div class="card-body" id="chapter-section">
                        <p class="text-muted">Veuillez d'abord sélectionner 3 témoins</p>
                        
                        <div id="chapter-selection" style="display: none;">
                            <div class="row">
                                <div class="col-md-8">
                                    <label for="chapter-select" class="form-label">Chapitre</label>
                                    <select class="form-select" id="chapter-select">
                                        <option value="">-- Sélectionnez un chapitre --</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-primary w-100" id="btn-collate" onclick="launchCollation()">
                                        Lancer la collation
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Résultats de la collation -->
        <div class="row mt-4" id="results-section" style="display: none;">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Résultats de la collation</h5>
                            <div>
                                <span class="badge bg-info" id="verse-range-badge">Vers 1-20</span>
                                <span class="badge bg-primary" id="total-verses-badge">0 vers</span>
                                <span class="badge bg-warning text-dark" id="decisions-badge">0 variantes</span>
                                <span class="badge bg-success" id="conserved-badge" title="Variantes conservées">
                                    <i class="bi bi-bookmark-check"></i> 0 conservées
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <!-- Spinner de chargement -->
                        <div id="collation-loading" class="text-center p-5" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <p class="mt-3">Collation en cours...</p>
                        </div>

                        <!-- Tableau de collation -->
                        <div id="collation-table" style="display: none;">
                            <!-- En-têtes des témoins -->
                            <div class="collation-header">
                                <div class="verse-number-header">Vers</div>
                                <div class="witness-header" id="witness-header-1">Témoin 1</div>
                                <div class="witness-header" id="witness-header-2">Témoin 2</div>
                                <div class="witness-header" id="witness-header-3">Témoin 3</div>
                                <div class="actions-header"></div>
                            </div>

                            <!-- Conteneur des vers -->
                            <div id="verses-container"></div>
                        </div>

                        <!-- Message si pas de résultats -->
                        <div id="no-results" class="text-center p-5">
                            <p class="text-muted">Cliquez sur "Lancer la collation" pour commencer</p>
                        </div>
                    </div>
                    
                    <!-- Pagination et actions -->
                    <div class="card-footer" id="collation-footer" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button class="btn btn-outline-secondary btn-sm" id="prev-page-btn" onclick="previousPage()" disabled>
                                    <i class="bi bi-chevron-left"></i> Précédent
                                </button>
                                <span class="mx-3">Page <span id="current-page">1</span> / <span id="total-pages">1</span></span>
                                <button class="btn btn-outline-secondary btn-sm" id="next-page-btn" onclick="nextPage()">
                                    Suivant <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-outline-info btn-sm" id="footer-decisions-badge" onclick="showCurrentDecisions()" title="Voir les décisions en cours">
                                    <i class="bi bi-pencil-square"></i> 0 décisions en cours
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="cancelAllDecisions()">
                                    <i class="bi bi-x-circle"></i> Annuler
                                </button>
                                <button class="btn btn-success btn-sm" onclick="saveAllDecisions()">
                                    <i class="bi bi-floppy"></i> Enregistrer
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bouton Exporter (en dehors de la card) -->
        <div class="row mt-4 mb-4" id="export-section" style="display: none;">
            <div class="col-md-12 text-center">
                <button class="btn btn-primary btn-lg" onclick="openExportModal()">
                    <i class="bi bi-download"></i> Exporter
                </button>
                <div class="text-muted small mt-1">Exporter l'ensemble des décisions pour <span id="export-work-name"></span></div>
            </div>
        </div>
    </div>

    <!-- Modal : Ajouter une œuvre -->
    <div class="modal fade" id="addWorkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajouter une nouvelle œuvre</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-work-form">
                        <div class="mb-3">
                            <label for="work-name" class="form-label">Nom de l'œuvre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="work-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="work-author" class="form-label">Auteur (optionnel)</label>
                            <input type="text" class="form-control" id="work-author">
                        </div>
                        <div class="mb-3">
                            <label for="work-date" class="form-label">Date (optionnel)</label>
                            <input type="text" class="form-control" id="work-date" placeholder="ex: XVIe siècle">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="addWorkBtn" onclick="addWork()">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal : Ajouter un témoin -->
    <div class="modal fade" id="addWitnessModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajouter un nouveau témoin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-witness-form">
                        <div class="mb-3">
                            <label for="witness-file" class="form-label">Fichier JSON <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="witness-file" accept=".json" required onchange="updateWitnessNameFromFile()">
                            <div class="form-text">Sélectionnez un fichier JSON contenant les transcriptions</div>
                        </div>
                        <div class="mb-3">
                            <label for="witness-name" class="form-label">Nom du témoin <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="witness-name" required placeholder="ex: BnF 1712">
                            <div class="form-text">Le nom est pré-rempli depuis le fichier, vous pouvez le modifier</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="addWitnessBtn" onclick="addWitness()">Ajouter</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal : Modifier une œuvre -->
    <div class="modal fade" id="editWorkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier l'œuvre</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-work-form">
                        <input type="hidden" id="edit-work-id">
                        <div class="mb-3">
                            <label for="edit-work-name" class="form-label">Nom de l'œuvre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit-work-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-work-author" class="form-label">Auteur</label>
                            <input type="text" class="form-control" id="edit-work-author">
                        </div>
                        <div class="mb-3">
                            <label for="edit-work-date" class="form-label">Date</label>
                            <input type="text" class="form-control" id="edit-work-date" placeholder="ex: XVIe siècle">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="updateWork()">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal : Confirmer suppression œuvre -->
    <div class="modal fade" id="deleteWorkModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmer la suppression</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="delete-work-id">
                    <p class="mb-3">Êtes-vous sûr de vouloir supprimer l'œuvre <strong id="delete-work-name"></strong> ?</p>
                    <div class="alert alert-warning mb-0">
                        <strong>Attention :</strong> Cette action supprimera également :
                        <ul class="mb-0 mt-2">
                            <li>Tous les témoins associés (<span id="delete-work-witness-count">0</span>)</li>
                            <li>Tous les fichiers liés</li>
                        </ul>
                        <p class="mt-2 mb-0"><strong>Cette action est irréversible.</strong></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" onclick="deleteWork()">Supprimer définitivement</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal : Modifier un témoin -->
    <div class="modal fade" id="editWitnessModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier le témoin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-witness-form">
                        <input type="hidden" id="edit-witness-work-id">
                        <input type="hidden" id="edit-witness-id">
                        <div class="mb-3">
                            <label for="edit-witness-name" class="form-label">Nom du témoin <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit-witness-name" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="updateWitness()">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal : Confirmer suppression témoin -->
    <div class="modal fade" id="deleteWitnessModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmer la suppression</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="delete-witness-work-id">
                    <input type="hidden" id="delete-witness-id">
                    <p class="mb-3">Êtes-vous sûr de vouloir supprimer ce témoin ?</p>
                    <div class="alert alert-warning mb-0">
                        <strong>Attention :</strong> Cette action supprimera :
                        <ul class="mb-0 mt-2">
                            <li>Le témoin "<strong id="delete-witness-name"></strong>"</li>
                            <li>Le fichier JSON associé</li>
                        </ul>
                        <p class="mt-2 mb-0"><strong>Cette action est irréversible.</strong></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" onclick="deleteWitness()">Supprimer définitivement</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal : Qualifier une variante -->
    <div class="modal fade" id="qualifyVariantModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Qualifier le vers <span id="qualify-verse-number"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="qualify-verse-number-input">
                    
                    <!-- Affichage des 3 versions -->
                    <div class="mb-4">
                        <h6>Versions du vers :</h6>
                        <div class="row">
                            <div class="col-4">
                                <strong id="qualify-witness-1-name">Témoin 1</strong>
                                <div class="p-2 border rounded mt-2 bg-light" id="qualify-witness-1-text" style="min-height: 60px;"></div>
                            </div>
                            <div class="col-4">
                                <strong id="qualify-witness-2-name">Témoin 2</strong>
                                <div class="p-2 border rounded mt-2 bg-light" id="qualify-witness-2-text" style="min-height: 60px;"></div>
                            </div>
                            <div class="col-4">
                                <strong id="qualify-witness-3-name">Témoin 3</strong>
                                <div class="p-2 border rounded mt-2 bg-light" id="qualify-witness-3-text" style="min-height: 60px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Qualification -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Type de variante :</strong></label>
                        <select class="form-select" id="qualification-type">
                            <option value="">-- Sélectionner --</option>
                            <option value="identical">Identique (pas de variante)</option>
                            <option value="equivalent">Équivalent (sens identique)</option>
                            <option value="minor">Variante mineure (orthographe)</option>
                            <option value="significant">Variante significative</option>
                            <option value="major">Variante majeure</option>
                            <option value="omission">Omission</option>
                            <option value="addition">Addition</option>
                        </select>
                    </div>

                    <!-- Équivalences -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Témoins équivalents :</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="equiv-1-2">
                            <label class="form-check-label" for="equiv-1-2">
                                <span id="equiv-1-2-label">Témoin 1 = Témoin 2</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="equiv-1-3">
                            <label class="form-check-label" for="equiv-1-3">
                                <span id="equiv-1-3-label">Témoin 1 = Témoin 3</span>
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="equiv-2-3">
                            <label class="form-check-label" for="equiv-2-3">
                                <span id="equiv-2-3-label">Témoin 2 = Témoin 3</span>
                            </label>
                        </div>
                    </div>

                    <!-- Lecture sélectionnée -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Lecture retenue :</strong></label>
                        <select class="form-select" id="selected-reading">
                            <option value="">-- Aucune --</option>
                            <option value="0">Témoin 1</option>
                            <option value="1">Témoin 2</option>
                            <option value="2">Témoin 3</option>
                        </select>
                    </div>

                    <!-- Notes -->
                    <div class="mb-3">
                        <label for="qualification-notes" class="form-label"><strong>Notes / Commentaires :</strong></label>
                        <textarea class="form-control" id="qualification-notes" rows="3" placeholder="Ajouter des notes sur cette variante..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-danger" onclick="clearDecision()">Effacer la décision</button>
                    <button type="button" class="btn btn-primary" onclick="saveDecision()">Enregistrer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Architecture modulaire -->
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
